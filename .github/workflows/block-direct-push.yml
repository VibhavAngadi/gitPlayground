name: block-direct-push
on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-and-revert:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.revert.outputs.should_run || steps.skip.outputs.should_run }}
      revert_pr_number: ${{ steps.revert.outputs.revert_pr_number }}
      revert_branch: ${{ steps.revert.outputs.revert_branch }}
      touches_workflows: ${{ steps.detect_files.outputs.touches_workflows || steps.skip.outputs.touches_workflows }}
    steps:
      - name: Inspect event
        run: |
          echo "PUSH SHA: $GITHUB_SHA"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Event path: $GITHUB_EVENT_PATH"
          echo "Commits:"
          jq -r '.commits[]? | "\(.id) \(.message)"' "$GITHUB_EVENT_PATH" || true
      
      - name: Detect workflow file changes in this push
        id: detect_files
        run: |
          set -euo pipefail
          files=$(jq -r '.commits[]? | (.added[]?, .modified[]?, .removed[]?)' "$GITHUB_EVENT_PATH" | sort -u)
          if echo "$files" | grep -q '^\.github/workflows/'; then
            echo "touches_workflows=true" >> $GITHUB_OUTPUT
          else
            echo "touches_workflows=false" >> $GITHUB_OUTPUT
          fi

      - name: Check whether commit is associated with a PR
        id: check_pr
        run: |
          # Query the "pulls associated with commit" endpoint
          resp=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls")
          echo "$resp" > pulls.json
          count=$(jq 'length' pulls.json)
          echo "pulls_count=$count" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Abort if this push came from a PR merge (or has associated PR)
        if: ${{ steps.check_pr.outputs.pulls_count != '0' }}
        id: skip
        run: |
          echo "This commit is associated with a PR (merge). Nothing to do."
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "touches_workflows=false" >> $GITHUB_OUTPUT
      
      - name: Revert direct push (create revert branch and open revert PR)
        if: ${{ steps.check_pr.outputs.pulls_count == '0' }}
        id: revert
        env:
          GITHUB_TOKEN: ${{ github.token }}
          ADMIN_PAT: ${{ secrets.ADMIN_PAT }}
          AUTH_TOKEN: ${{ secrets.ADMIN_PAT || github.token }}
          REPO: ${{ github.repository }}
          SHORT_SHA: ${{ github.sha }}
          EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail
          # If workflow files were touched, a PAT with workflow scope is required.
          files=$(jq -r '.commits[]? | (.added[]?, .modified[]?, .removed[]?)' "$EVENT_PATH" | sort -u)
          if echo "$files" | grep -q '^\.github/workflows/'; then
            if [ -z "${ADMIN_PAT:-}" ]; then
              echo "Direct push touched .github/workflows/. Set ADMIN_PAT with repo+workflow scopes."
              exit 1
            fi
          fi

          # load commits from push event (the event payload has `.commits[]`)
          # Revert newest -> oldest to avoid conflicts when commits touch same lines
          commits=$(jq -r '.commits | reverse | .[].id' "$EVENT_PATH")
          if [ -z "${commits}" ]; then
            echo "No commits found in event payload; nothing to revert."
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Detected direct push to main (no associated PR). Will create a revert branch and open a PR."
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # clone full history
          git clone "https://x-access-token:${AUTH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git fetch --all
          git checkout main

          BRANCH="revert/direct-push-${SHORT_SHA::7}"
          git checkout -b "$BRANCH"

          # revert each commit in order (oldest->newest)
          for c in $commits; do
            echo "Reverting commit $c"
            # If a commit fails to revert cleanly we stop so human can inspect
            parents=$(git rev-list --parents -n 1 "$c" | wc -w | tr -d ' ')
            if [ "$parents" -gt 2 ]; then
              git revert --no-edit -m 1 "$c"
            else
              git revert --no-edit "$c"
            fi
          done

          git push "https://x-access-token:${AUTH_TOKEN}@github.com/${REPO}.git" "HEAD:refs/heads/${BRANCH}"

          # Create PR via API
          title="Revert direct push ${SHORT_SHA::7} to main"
          body="Automated revert PR: this was created because commits were pushed directly to main without a PR. Please review & merge to restore repository state.\n\nDirect push SHA: ${SHORT_SHA}\n\n(If this was a mistaken revert, please investigate.)"

          create_resp=$(curl -s -X POST -H "Authorization: token ${AUTH_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/pulls" \
            -d "$(jq -n --arg t "$title" --arg b "$body" --arg h "$BRANCH" '{title:$t, head:$h, base:"main", body:$b}')")

          echo "Create PR response:"
          echo "$create_resp" | jq .

          pr_number=$(echo "$create_resp" | jq -r '.number // empty')
          if [ -z "$pr_number" ]; then
            echo "Failed to create revert PR."
            exit 1
          fi

          echo "revert_pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "revert_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "should_run=true" >> $GITHUB_OUTPUT
          if echo "$files" | grep -q '^\.github/workflows/'; then
            echo "touches_workflows=true" >> $GITHUB_OUTPUT
          else
            echo "touches_workflows=false" >> $GITHUB_OUTPUT
          fi

  approve-and-reapply:
    needs: detect-and-revert
    if: ${{ needs.detect-and-revert.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ github.token }}
      ADMIN_PAT: ${{ secrets.ADMIN_PAT }}
      AUTH_TOKEN: ${{ secrets.ADMIN_PAT || github.token }}
      REPO: ${{ github.repository }}
      SHORT_SHA: ${{ github.sha }}
      EVENT_PATH: ${{ github.event_path }}
      REVERT_PR_NUMBER: ${{ needs.detect-and-revert.outputs.revert_pr_number }}
      REVERT_MERGE_METHOD: ${{ vars.REVERT_MERGE_METHOD || 'merge' }}
      TOUCHES_WORKFLOWS: ${{ needs.detect-and-revert.outputs.touches_workflows }}
    steps:
      - name: Merge revert PR
        run: |
          set -euo pipefail
          if [ -z "${REVERT_PR_NUMBER}" ]; then
            echo "Missing revert PR number."
            exit 1
          fi

          payload=$(jq -n --arg method "$REVERT_MERGE_METHOD" '{merge_method:$method}')
          resp=$(curl -s -X PUT -H "Authorization: token ${AUTH_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/pulls/${REVERT_PR_NUMBER}/merge" \
            -d "$payload")

          merged=$(echo "$resp" | jq -r '.merged // false')
          if [ "$merged" != "true" ]; then
            echo "Failed to merge revert PR."
            echo "$resp" | jq .
            exit 1
          fi

      - name: Create reapply PR (cherry-pick direct push commits)
        run: |
          set -euo pipefail
          if [ "${TOUCHES_WORKFLOWS}" = "true" ] && [ -z "${ADMIN_PAT:-}" ]; then
            echo "Reapply would touch .github/workflows/. Set ADMIN_PAT with repo+workflow scopes."
            exit 1
          fi
          commits=$(jq -r '.commits | .[].id' "$EVENT_PATH")
          if [ -z "${commits}" ]; then
            echo "No commits found in event payload; nothing to reapply."
            exit 0
          fi

          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          git clone "https://x-access-token:${AUTH_TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git fetch --all
          git checkout main
          git pull --ff-only

          BRANCH="reapply/direct-push-${SHORT_SHA::7}"
          git checkout -b "$BRANCH"

          for c in $commits; do
            echo "Cherry-picking commit $c"
            parents=$(git rev-list --parents -n 1 "$c" | wc -w | tr -d ' ')
            if [ "$parents" -gt 2 ]; then
              git cherry-pick -m 1 "$c"
            else
              git cherry-pick "$c"
            fi
          done

          git push "https://x-access-token:${AUTH_TOKEN}@github.com/${REPO}.git" "HEAD:refs/heads/${BRANCH}"

          title="Apply direct push ${SHORT_SHA::7} via PR"
          body="This PR re-applies commits that were pushed directly to main. It was created automatically after the revert was approved and merged.\n\nOriginal direct push SHA: ${SHORT_SHA}"

          create_resp=$(curl -s -X POST -H "Authorization: token ${AUTH_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/pulls" \
            -d "$(jq -n --arg t "$title" --arg b "$body" --arg h "$BRANCH" '{title:$t, head:$h, base:"main", body:$b}')")

          echo "Create PR response:"
          echo "$create_resp" | jq .

          pr_number=$(echo "$create_resp" | jq -r '.number // empty')
          if [ -z "$pr_number" ]; then
            echo "Failed to create reapply PR."
            exit 1
          fi
